#!/bin/bash
while true; do
  # Check whether there is an OSM file in the tmp folder.
  # If this is not the case the generating process is done
  if [ $(ls tmp | grep -c "\.osm") -eq 0 ]; then
   # When done generating tiles, notify the user and copy the generated files to
   #the openseamap folder of the tilestache cache
   echo "Finished generating Tiles"
   echo "Starting copying of tiles to Tilestache Cache folder located at:
                ~/Geostack/tilestache-server/cache/openseamap-local"
   cp -a tiles/. ../../cache/openseamap-local
   exit
  else
    # For each file in the temporarie folder execute the code below.
    for file in $(ls tmp | grep "\.osm"); do
      echo "Generating SVG's from OSM file: " $file
      # The y , x and z (zoom level) of the tile is assigned to the variable it
      # belongs to.
      tx=$(echo $file | cut -f 1 -d'-')
      ty=$(echo $file | cut -f 2 -d'-')
      z=$(echo $file | cut -f 3 -d'-')
      z=$(echo $z | cut -f 1 -d'.')

      # If the zoom level is equal to 12 execute the code below. This is because
      # openseamap data is not shown below zoom level 12.
      # NOTE: The higher the zoomlevel the more zoomed in you are in the map.
      #       So if the zoomlevel is equal to 18 you are zoomed in far.
      if [ $z = 12 ]; then
        # for every number between 12 and 18 (zoomlevels) execute the code below.
        for k in {12..18}; do
           # The line below assigns the correct OpenSeamap symbol to the correct
           # svg icon
            ../searender/searender ../searender/symbols/symbols.defs $k \
            >tmp/$tx-$ty-$k.svg <tmp/$file
        done;

      # If the zoom level is equal to 12 execute the code below. This is because
      # openseamap data is not shown below zoom level 12.
      else
         # The line below assigns the correct OpenSeamap symbol to the correct
         # svg icon.
         ../searender/searender ../searender/symbols/symbols.defs $z \
           >tmp/$tx-$ty-$z.svg <tmp/$file
      fi
      # The code below is always executed no matter what the zoom level is.
      # The line below makes sure the file is removed from the tmp folder after
      # the tiles have been generated.
      rm tmp/$file

      # the Jtile application is started to generated the png's using the svg's
      # generated by the jsearch application.
      java -jar jtile.jar tmp/ tiles/ $z $tx $ty
     done
  fi
done
